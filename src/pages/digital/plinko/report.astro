---
import DefaultSiteLayout from "@/components/layout/DefaultSiteLayout.astro";
import Grid from "@/components/layout/Grid.astro";
import Section from "@/components/layout/Section.astro";
import PlinkoReportDashboard from "@/components/plinko-report/PlinkoReportDashboard";
import PlinkoDashboard from "@/components/plinko-report/PlinkoReportDashboard";
import { db } from "@/db";
import { tablePlinkoGameRounds, tablePlinkoGames } from "@/db/schema";
import { getUser } from "@/lib/server/auth.utils";
import { getAllScores, getUniqueUsers, listTop10Games } from "@/lib/server/loaders/plinkoReportingLoaders";
import { listTopGamesWithUsers } from "@/lib/server/loaders/listTopGamesWithUsers";
import { requireNum } from "@/lib/server/parse_int";
import { desc, eq, gt, inArray } from "drizzle-orm";

// const user = getUser(Astro);

// if (!user) {
//   return Astro.redirect(getPagePath($router, "login"));
// }

// const { gameId: gameId_ } = Astro.params;

// if (!gameId_) throw new Error("No game ID provided");

// const gameId = requireNum(gameId_);

await listTop10Games();
await getAllScores();
await getUniqueUsers();

// TODO: consider batching https://orm.drizzle.team/docs/batch-api

//

// Get the game from the database
// const plinkoGameWithRounds = await db
//   .select({
//     game: tablePlinkoGames, // This will include all columns from the plinkoGames table
//     round: tablePlinkoGameRounds, // This includes all columns from the plinkoGameRounds table
//   })
//   .from(tablePlinkoGames)
//   .leftJoin(
//     tablePlinkoGameRounds,
//     eq(tablePlinkoGames.id, tablePlinkoGameRounds.game_id)
//   )
//   .where(eq(tablePlinkoGames.id, gameId));

// if (plinkoGameWithRounds.length === 0) {
//   throw new Error("Game not found");
// }
---

<DefaultSiteLayout title="Plinko Report">
  <main class="relative">
    <Section className="pt-12 sm:pt-24 md:pt-[20vh] lg:pt-[22vh] pb-48">
      <!-- <Grid id="report">
        <div slot="left" class="flex-col justify-start items-center md:ml-10">
          <div class="flex flex-row justify-start items-center pt-32 lg:pt-6"> -->
      <h1 class="font-bold text-xl">The Adpharmâ€™s Holiday Plinko Report</h1>
      <!-- </div> -->
      <PlinkoReportDashboard  client:load/>
      <!-- </div> -->
      <!-- <div slot="right"> -->
      <!-- <div -->
      <!-- class="pt-12 grid grid-cols-1 lg:grid-cols-2 gap-8 text-zinc-400 animate-fade-in-2" -->
      <!-- > -->
      <!-- <div></div> -->

      <!-- <div></div> -->
      <!-- </div> -->
      <!-- </div> -->
      <!-- </Grid> -->
    </Section>
  </main>
</DefaultSiteLayout>
